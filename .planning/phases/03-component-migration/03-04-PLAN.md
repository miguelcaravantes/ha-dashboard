---
phase: 03-component-migration
plan: 04
type: execute
wave: 3
depends_on: ['03-02', '03-03']
files_modified:
  [
    src/features/LightDetail/index.ts,
    src/features/LightDetail/useLightDetail.ts,
    src/features/LightDetail/LightDetail.tsx,
    src/features/LightDetail/LightColor.tsx,
    src/features/LightDetail/LightBrightness.tsx,
    src/features/LightDetail/LightGroup.tsx,
    src/features/FanDetail.tsx,
    src/features/EntityDialog.tsx,
    src/features/EntityCard/PowerSwitch.tsx,
  ]
autonomous: true

must_haves:
  truths:
    - 'Light and Fan detail dialogs are strictly typed'
    - 'Entity toggle actions use React 19 useActionState'
    - 'Detail views show visual feedback during service calls (pending state)'
  artifacts:
    - path: 'src/features/LightDetail/useLightDetail.ts'
      provides: 'Strictly typed light logic'
    - path: 'src/features/EntityCard/PowerSwitch.tsx'
      provides: 'Toggle action with useActionState'
  key_links:
    - from: 'src/features/EntityCard/PowerSwitch.tsx'
      to: 'react'
      via: 'useActionState'
---

<objective>
Migrate complex detail view components to TSX and implement React 19 Actions for state mutations.
This provides a more robust way to handle asynchronous service calls to Home Assistant, with native support for pending states and optimistic updates.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-component-migration/03-RESEARCH.md
@src/features/LightDetail/LightDetail.jsx
@src/features/LightDetail/useLightDetail.js
@src/features/EntityCard/PowerSwitch.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate LightDetail Components to TSX</name>
  <files>src/features/LightDetail/index.ts, src/features/LightDetail/useLightDetail.ts, src/features/LightDetail/LightDetail.tsx, src/features/LightDetail/LightColor.tsx, src/features/LightDetail/LightBrightness.tsx, src/features/LightDetail/LightGroup.tsx</files>
  <action>
    Convert all files in src/features/LightDetail to TS/TSX.
    Define interfaces for Props and state objects.
    Resolve strict TS errors, paying close attention to attribute access (brightness, rgb_color, etc.).
    Ensure the index.ts properly exports the main component.
  </action>
  <verify>Run `npx tsc --noEmit` and ensure no errors.</verify>
  <done>LightDetail suite is strictly typed.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate FanDetail and EntityDialog to TSX</name>
  <files>src/features/FanDetail.tsx, src/features/EntityDialog.tsx</files>
  <action>
    Rename FanDetail.jsx and EntityDialog.jsx to .tsx.
    Define Prop interfaces.
    Handle dialog state and child component typing strictly.
  </action>
  <verify>Run `npx tsc --noEmit` and ensure no errors.</verify>
  <done>Dialog and Fan components are strictly typed.</done>
</task>

<task type="auto">
  <name>Task 3: Implement React Actions for Mutations</name>
  <files>src/features/EntityCard/PowerSwitch.tsx, src/features/LightDetail/useLightDetail.ts</files>
  <action>
    In PowerSwitch.tsx, refactor the toggle logic to use `useActionState`.
    In useLightDetail.ts, refactor service calls (like color change or toggle) to use `useActionState` or `useTransition`.
    Update the UI to utilize the `isPending` state provided by these hooks to show loading indicators or disable buttons during in-flight requests.
  </action>
  <verify>Toggle a light/switch and verify that visual feedback is shown while the request is pending.</verify>
  <done>State mutations use modern React 19 Actions pattern.</done>
</task>

</tasks>

<verification>
Run `npx tsc --noEmit`.
Test light toggle and detail view interactions.
Confirm pending states are visible in the UI.
</verification>

<success_criteria>

- All detail components compile in strict mode.
- PowerSwitch uses `useActionState`.
- Detail views show pending feedback during service calls.
  </success_criteria>

<output>
After completion, create `.planning/phases/03-component-migration/03-04-SUMMARY.md`
</output>
