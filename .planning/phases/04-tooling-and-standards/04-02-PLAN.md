---
phase: 04-tooling-and-standards
plan: 02
type: execute
wave: 2
depends_on: ['04-01']
files_modified:
  [
    eslint.config.js,
    src/common/utils/typeGuards.ts,
    src/common/hooks/useEntity.ts,
  ]
autonomous: true
must_haves:
  truths:
    - "ESLint strictly forbids 'as' and '<Type>' assertions"
    - 'Robust type guards exist for Home Assistant entities and states'
    - 'Core useEntity hook is refactored to be assertion-free'
  artifacts:
    - path: 'src/common/utils/typeGuards.ts'
      provides: 'Reusable type-narrowing functions'
    - path: 'src/common/hooks/useEntity.ts'
      provides: 'Assertion-free entity state access'
  key_links:
    - from: 'src/common/hooks/useEntity.ts'
      to: 'src/common/utils/typeGuards.ts'
      via: 'import'
      pattern: 'isEntity'
---

<objective>
Enforce strict type assertion rules and provide safe alternatives through type guards. Refactor the core useEntity hook to eliminate unsafe casting.

Purpose: Prevent runtime errors caused by incorrect type assumptions.
Output: Enabled assertion lint rules and type guard infrastructure.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-tooling-and-standards/04-CONTEXT.md
@.planning/phases/04-tooling-and-standards/04-RESEARCH.md
@.planning/phases/04-tooling-and-standards/04-01-SUMMARY.md
@src/common/hooks/useEntity.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enforce Strict Assertions</name>
  <files>eslint.config.js</files>
  <action>
    1. Update `eslint.config.js` to enable the following rules:
       - `@typescript-eslint/consistent-type-assertions`: ["error", { "assertionStyle": "never" }]
       - `@typescript-eslint/no-non-null-assertion`: "error"
    2. Note: The `assertionStyle: "never"` rule will cause many existing lines to fail; this is intended and will be addressed in subsequent tasks and plans.
    3. Exceptions: Ensure `as const` remains allowed as it is safe for literal narrowing.
  </action>
  <verify>
    - `npm run lint` identifies all `as` assertions in the codebase as errors.
  </verify>
  <done>The linter now strictly forbids unsafe type assertions.</done>
</task>

<task type="auto">
  <name>Task 2: Create Type Guard Infrastructure</name>
  <files>src/common/utils/typeGuards.ts</files>
  <action>
    1. Implement a set of robust type guards in `src/common/utils/typeGuards.ts`:
       - `isString(val: unknown): val is string`
       - `isNumber(val: unknown): val is number`
       - `isEntityId(val: unknown): val is EntityId` (template literal `${string}.${string}`)
       - `isHass(val: unknown): val is HomeAssistant`
       - `isDefined<T>(val: T | undefined | null): val is T`
    2. Add specific guards for common Home Assistant attributes (e.g., `hasBrightness`, `hasTemperature`).
    3. Use these guards to safely narrow `any` or `Record<string, any>` values.
  </action>
  <verify>
    - The utility file exports all necessary guards.
    - Type guards correctly narrow types in simple test cases.
  </verify>
  <done>A reusable foundation for safe type narrowing is established.</done>
</task>

<task type="auto">
  <name>Task 3: Refactor useEntity Hook</name>
  <files>src/common/hooks/useEntity.ts</files>
  <action>
    1. Refactor `src/common/hooks/useEntity.ts` to remove all `as` assertions (there are ~10 instances).
    2. Replace assertions with:
       - Generic hook usage: `useEntity<LightEntity>(...)`.
       - Type guards from `Task 2` for attribute access.
       - Logic changes to handle potentially undefined values safely (e.g., early returns or fallbacks).
    3. Ensure the hook remains backward compatible in its return type.
  </action>
  <verify>
    - `src/common/hooks/useEntity.ts` passes lint without assertion errors.
    - `tsc` confirms the types are correctly inferred through guards.
  </verify>
  <done>The most critical hook in the codebase is now type-safe and assertion-free.</done>
</task>

</tasks>

<verification>
1. Run `npm run lint` specifically on `src/common/hooks/useEntity.ts` and `src/common/utils/typeGuards.ts`.
2. Confirm that `as` assertions are correctly flagged in other files.
</verification>

<success_criteria>

- ESLint configuration is updated with strict assertion rules.
- `typeGuards.ts` is created with necessary utility functions.
- `useEntity.ts` is refactored and contains zero `as` assertions.
  </success_criteria>

<output>
After completion, create `.planning/phases/04-tooling-and-standards/04-02-SUMMARY.md`
</output>
